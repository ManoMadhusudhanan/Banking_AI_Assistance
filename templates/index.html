<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Banking AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
  />

  <style>
    :root {
      --bg: #f4f5f7;
      --sidebar-bg: #111827;
      --sidebar-text: #e5e7eb;
      --chat-bg: #ffffff;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb;
      --accent-soft: #e0edff;
      --user-bubble: #2563eb;
      --bot-bubble: #f3f4f6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100vh;
      display: flex;
      justify-content: center;
    }

    .app-container {
      display: flex;
      width: 100%;
      max-width: 1300px;
      height: 100vh;
      background: #ffffff;
    }

    /* ENSURE RIGHT PANEL STAYS RIGHT */
    .history-panel {
      width: 260px;
      background: #ffffff;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border);
    }

    /* DO NOT WRAP PANELS */
    .app-container {
      flex-wrap: nowrap;
}

    /* LEFT SIDEBAR */
    .sidebar {
      width: 240px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .logo-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: linear-gradient(135deg, #fb923c, #f97316);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: #111827;
    }

    .logo-text-main {
      font-size: 18px;
      font-weight: 600;
    }

    .logo-text-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .menu {
      margin-top: 10px;
    }

    .menu-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .menu-item {
      padding: 10px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      border-radius: 8px;
      cursor: pointer;
      color: #d1d5db;
      font-size: 14px;
    }

    .menu-item i {
      width: 18px;
      text-align: center;
      font-size: 14px;
    }

    .menu-item.active,
    .menu-item:hover {
      background: #1f2937;
      color: #f9fafb;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 11px;
      color: #9ca3af;
      line-height: 1.4;
    }

    /* MAIN CHAT PANEL */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: var(--chat-bg);
      border-left: 1px solid var(--border);
      border-right: 1px solid var(--border);
    }

    .chat-header {
      padding: 14px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fafafa;
    }

    .chat-header-left h2 {
      margin: 0;
      font-size: 17px;
    }

    .chat-header-left span {
      font-size: 12px;
      color: var(--text-muted);
    }

    .search-input {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 8px 12px;
      font-size: 13px;
      width: 220px;
    }

    .chips-row {
      padding: 10px 18px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      background: #f9fafb;
    }

    .suggest-chip {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
    }

    .suggest-chip:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text-main);
    }

    .chat-body {
      flex: 1;
      padding: 18px 18px 10px 18px;
      overflow-y: auto;
      background: #f3f4f6;
    }

    .msg-row {
      display: flex;
      margin-bottom: 10px;
    }

    .msg-row.user {
      justify-content: flex-end;
    }

    .msg-bubble {
      max-width: 70%;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    .msg-bubble.bot {
      background: var(--bot-bubble);
      border: 1px solid var(--border);
      color: var(--text-main);
      border-top-left-radius: 4px;
    }

    .msg-bubble.user {
      background: var(--user-bubble);
      color: #ffffff;
      border-top-right-radius: 4px;
    }

    .chat-input-box {
      border-top: 1px solid var(--border);
      padding: 10px 16px;
      background: #ffffff;
      display: flex;
      gap: 10px;
      align-items: flex-end;


    }

    #userInput {
      flex: 1;
      resize: none;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 14px;
      font-family: inherit;
      min-height: 42px;
      max-height: 120px;
      background: #f9fafb;
      color: var(--text-main);
    }

    #userInput:focus {
      outline: none;
      border-color: var(--accent);
      background: #ffffff;
    }

    #sendBtn {
      border: none;
      border-radius: 10px;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 500;
      background: var(--accent);
      color: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    #sendBtn:disabled {
      opacity: 0.7;
      cursor: default;
    }

    #sendBtn:hover:not(:disabled) {
      background: #1d4ed8;
    }

    /* RIGHT HISTORY PANEL */
    .history-panel {
      width: 260px;
      background: #ffffff;
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
    }

    .history-panel h3 {
      margin: 0 0 10px 0;
      font-size: 15px;
    }

    .history-list {
      margin-top: 4px;
      overflow-y: auto;
      flex: 1;
    }

    .history-empty {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .history-item {
      padding: 8px 10px;
      background: #f9fafb;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      font-size: 13px;
      color: var(--text-main);
      transition: background 0.15s, border-color 0.15s;
    }

    .history-item:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
    }

    .history-time {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    @media (max-width: 900px) {
      .app-container {
        flex-direction: column;
        height: auto;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        gap: 16px;
        border-bottom: 1px solid var(--border);
      }
      .chat-panel {
        border-left: none;
        border-right: none;
      }
      .history-panel {
        display: none;
      }
      .msg-meta {
        font-size: 12px;
        color: #6b7280;
        margin-left: 10px;
        margin-top: 4px;
        font-style: italic;
      }


    }

      .image-preview {
        max-width: 220px;
        border-radius: 10px;
        margin-top: 6px;
        border: 1px solid #e5e7eb;
    }

  </style>
</head>

<body>

<div class="app-container">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo-row">
      <div class="logo-icon">B</div>
      <div>
        <div class="logo-text-main">Banking AI</div>
        <div class="logo-text-sub">Smart account assistant</div>
      </div>
    </div>

    <div class="menu">
      <div class="menu-label">Main</div>
      <div class="menu-item active">
        <i class="fa-solid fa-comments"></i>
        <span>AI Chat</span>
      </div>
      <div class="menu-item"><i class="fa-solid fa-credit-card"></i><span>Cards</span></div>
      <div class="menu-item"><i class="fa-solid fa-chart-column"></i><span>Insights</span></div>
      <div class="menu-item"><i class="fa-solid fa-gear"></i><span>Settings</span></div>
    </div>

    <div class="sidebar-footer">
      Demo assistant. Do not enter passwords or full card numbers.
    </div>
  </aside>

  <!--- CHAT PANEL -->
  <main class="chat-panel">
    <header class="chat-header">
      <div class="chat-header-left">
        <h2>AI Banking Assistant</h2>
        <span>Ask about transfers, charges, cards, loans & safety</span>
      </div>
      <input id="searchBar" class="search-input" type="text" placeholder="Search history..." />
    </header>



    <div id="chatBody" class="chat-body"></div>

    <div class="chat-input-box">
  
      <!-- Hidden file input -->
    <input
    type="file"
    id="imageInput"
    accept="image/*"
    style="display: none"
    />

    <!-- Plus button -->
    <button
    id="uploadBtn"
    title="Upload image"
    style="
      border: none;
      background: #f3f4f6;
      border-radius: 10px;
      width: 42px;
      height: 42px;
      cursor: pointer;
      font-size: 20px;
    "
    >
    ‚ûï
    </button>

      <!-- Text input -->
      <textarea
        id="userInput"
        placeholder="Type your question or upload an image..."
      ></textarea>
    
      <!-- Send button -->
      <button id="sendBtn">
        <span>Send</span>
        <i class="fa-solid fa-paper-plane"></i>
      </button>
    </div>
  </main> 

  <!-- HISTORY PANEL -->
  <aside class="history-panel">
    <h3>History</h3>
    <div id="historyList" class="history-list">
      <div id="historyEmpty" class="history-empty">Your recent questions appear here.</div>
    </div>
  </aside>
</div>
<script>
  let pendingImage = null;

  const BASE_URL = "http://127.0.0.1:8000";

  const chatBody = document.getElementById("chatBody");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const historyList = document.getElementById("historyList");
  const historyEmpty = document.getElementById("historyEmpty");

  let historyItems = [];

  const uploadBtn = document.getElementById("uploadBtn");
  const imageInput = document.getElementById("imageInput");

  uploadBtn.addEventListener("click", () => {
    imageInput.click();
  });


  /* ---------------- SESSION ID ---------------- */
  function getSessionId() {
    let sessionId = localStorage.getItem("session_id");

    if (!sessionId) {
      sessionId = (crypto?.randomUUID?.()) ||
        "sess-" + Math.random().toString(36).substring(2, 15);
      localStorage.setItem("session_id", sessionId);
    }
    return sessionId;
  }
  /* -------------------------------------------- */

  function addMessage(text, sender = "bot") {
    const row = document.createElement("div");
    row.className = "msg-row " + sender;

    const bubble = document.createElement("div");
    bubble.className = "msg-bubble " + sender;
    bubble.innerText = text;

    row.appendChild(bubble);
    chatBody.appendChild(row);
    chatBody.scrollTop = chatBody.scrollHeight;

    return bubble;
  }
  //------------------PREVIEW IMAGE----------

  function addImagePreview(file) {
  const row = document.createElement("div");
  row.className = "msg-row user";

  const bubble = document.createElement("div");
  bubble.className = "msg-bubble user";

  const img = document.createElement("img");
  img.className = "image-preview";
  img.src = URL.createObjectURL(file);

  bubble.appendChild(img);
  row.appendChild(bubble);
  chatBody.appendChild(row);
  chatBody.scrollTop = chatBody.scrollHeight;
}


imageInput.addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (!file) return;

  pendingImage = file;
  addImagePreview(file);
});

  // Typing animation
  function typeWriterEffect(element, text, speed = 20) {
    element.innerText = "";
    let index = 0;

    function type() {
      if (index < text.length) {
        element.innerText += text.charAt(index++);
        chatBody.scrollTop = chatBody.scrollHeight;
        setTimeout(type, speed);
      }
    }
    type();
  }

  // Chat history
  function addHistoryItem(question) {
    if (historyEmpty) historyEmpty.style.display = "none";

    const time = new Date().toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });

    historyItems.unshift({ question, timestamp: time });
    historyList.innerHTML = "";

    historyItems.forEach((item) => {
      const div = document.createElement("div");
      div.className = "history-item";
      div.innerHTML = `
        ${item.question.slice(0, 60)}
        <span class="history-time">${item.timestamp}</span>
      `;
      div.onclick = () => {
        userInput.value = item.question;
        sendMessage();
      };
      historyList.appendChild(div);
    });
  }

/* ---------------- SEND MESSAGE ---------------- */
async function sendMessage() {
  const text = userInput.value.trim();
  if (!text && !pendingImage) return;

  if (text) {
    addMessage(text, "user");
    addHistoryItem(text);
  }

  userInput.value = "";

  const loadingBubble = addMessage("Typing‚Ä¶", "bot");
  sendBtn.disabled = true;
  sendBtn.innerText = "Sending...";

  const sessionId = getSessionId();

  try {
    const formData = new FormData();
    formData.append("session_id", sessionId);
    formData.append("message", text);

    // ‚úÖ Send image ONLY if selected
    if (pendingImage) {
      formData.append("image", pendingImage);
      pendingImage = null;          // üî• clear after send
      imageInput.value = "";
    }

    const res = await fetch(`${BASE_URL}/chatbot/ask`, {
      method: "POST",
      body: formData
    });

    if (!res.ok) {
      throw new Error("Server error");
    }

    const data = await res.json();

    typeWriterEffect(
      loadingBubble,
      data?.reply || "‚ö†Ô∏è Could not process your request."
    );

    if (data.metrics) {
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.innerText = `‚ÑπÔ∏è RAG: ${
        data.metrics.used_rag ? "ON" : "OFF"
      } | Faithfulness: ${
        data.metrics.faithfulness ?? "-"
      } | Latency: ${data.metrics.latency}s`;

      loadingBubble.parentElement.appendChild(meta);
    }

  } catch (err) {
    loadingBubble.innerText = "‚ö†Ô∏è Unable to reach server. Please try again.";
    console.error(err);
  } finally {
    sendBtn.disabled = false;
    sendBtn.innerHTML = "Send <i class='fa-solid fa-paper-plane'></i>";
  }
}

  /* ---------------- EVENTS ---------------- */
  sendBtn.addEventListener("click", sendMessage);

  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  /* ---------------- INITIAL MESSAGE ---------------- */
  addMessage(
    "Hello! I am your Banking AI Assistant. Ask me anything about banking, transfers, accounts, or cards.",
    "bot"
  );
</script>


</body>
</html>
